version: '3.9'

services:
  frontend:
    container_name: frontend
    build: 
      context: ./frontend
      dockerfile: Dockerfile
    depends_on:
      - backend
    networks:
      - traefik-global-proxy
    
    ports:
      - '3000:3000'

    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.frontend.rule=Host(`yasarcakir.com`)'
      - 'traefik.http.routers.frontend.entrypoints=websecure'
      - 'traefik.http.routers.frontend.tls.certresolver=resolver'

  backend:
    container_name: backend
    build: 
      context: .
      dockerfile: Dockerfile

    environment:
      - NODE_ENV=production
    
    ports:
      - '4000:4000'

    networks:
      - traefik-global-proxy
    
    # Traefik stuff
    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.backend.rule=Host(`api.yasarcakir.com`)' 
      - 'traefik.http.routers.backend.entrypoints=websecure' 
      - 'traefik.http.routers.backend.tls.certresolver=resolver'

  traefik:
    image: traefik:latest
    container_name: traefik
    command:
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.resolver.acme.tlschallenge=true"
      - "--certificatesresolvers.resolver.acme.email=dev.yasarcakir@gmail.com"
      - "--certificatesresolvers.resolver.acme.storage=/letsencrypt/acme.json"
    
    labels:
      - traefik.enable=true
      - traefik.http.routers.traefik.rule=Host(`monitor.yasarcakir.com`)
      - traefik.http.routers.traefik.entrypoints=websecure
      - traefik.http.routers.traefik.service=api@internal
      - traefik.http.routers.traefik.tls.certresolver=resolver
      - 'traefik.http.routers.traefik.middlewares=traefik-auth'
      - 'traefik.http.middlewares.traefik-auth.basicauth.users=admin:$$apr1$$X5JQXJ5W$$4Z0Z0Z0Z0Z0Z0Z0Z0Z0Z0'

    ports:
      - '80:80'
      - '443:443'

    volumes:
      - "./letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    
networks:
  traefik-global-proxy:
    name: traefik-global-proxy

